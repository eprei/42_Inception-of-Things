= My notes

== Journal

=== Try to use qemu instead of virtual box

. Replace virtualbox with qemu in `p1/Vagrantfile`
+
[source, patch]
----
    ...
-   control.vm.provider "virtualbox" do |vb|
-           vb.memory = "512"
+   control.vm.provider "qemu" do |qe|
+           qe.memory = "512"
    ...
----

. Install libvirt plugin with vagrant
+
----
vagrant plugin install vagrant-libvrt
vagrant plugin install libvrt
----
+
but I receive this error message
+
----
Vagrant failed to load a configured plugin source. This can be caused
by a variety of issues including: transient connectivity issues, proxy
filtering rejecting access to a configured plugin source, or a configured
plugin source not responding correctly. Please review the error message
below to help resolve the issue:

  Net::OpenTimeout: Failed to open TCP connection to gems.hashicorp.com:443 (execution expired) (https://gems.hashicorp.com/specs.4.8.gz)

Source: https://gems.hashicorp.com/
----

=== Install virtualbox on archlinux

Install "virtualbox-host-modules-arch" for my Arch Linux

Install virtualbox plugin
+
----
vagrant plugin install virtualbox
----
+
I receive this
+
----
The provider 'virtualbox' that was requested to back the machine
'epresa-cS' is reporting that it isn't usable on this system. The
reason is shown below:

VirtualBox is complaining that the kernel module is not loaded. Please
run `VBoxManage --version` or open the VirtualBox GUI to see the error
message which should contain instructions on how to fix this error.
----

I reboot my computer to load the `vboxdrv` kernel module

=== Launch vagrant

----
vagrant up
----
+
----
$ vagrant up
Bringing machine 'epresa-cS' up with 'virtualbox' provider...
Bringing machine 'epresa-cSW' up with 'virtualbox' provider...
===> epresa-cS: Box 'centos/7' could not be found. Attempting to find and install...
    epresa-cS: Box Provider: virtualbox
    epresa-cS: Box Version: >= 0
===> epresa-cS: Loading metadata for box 'centos/7'
    epresa-cS: URL: https://vagrantcloud.com/api/v2/vagrant/centos/7
===> epresa-cS: Adding box 'centos/7' (v2004.01) for provider: virtualbox
    epresa-cS: Downloading: https://vagrantcloud.com/centos/boxes/7/versions/2004.01/providers/virtualbox/unknown/vagrant.box
Download redirected to host: cloud.centos.org
    epresa-cS: Calculating and comparing box checksum...
===> epresa-cS: Successfully added box 'centos/7' (v2004.01) for 'virtualbox'!
===> epresa-cS: Preparing master VM for linked clones...
    epresa-cS: This is a one time operation. Once the master VM is prepared,
    epresa-cS: it will be used as a base for linked clones, making the creation
    epresa-cS: of new VMs take milliseconds on a modern system.
===> epresa-cS: Importing base box 'centos/7'...
===> epresa-cS: Cloning VM...
===> epresa-cS: Matching MAC address for NAT networking...
===> epresa-cS: Checking if box 'centos/7' version '2004.01' is up to date...
===> epresa-cS: Setting the name of the VM: Server
===> epresa-cS: Clearing any previously set network interfaces...
===> epresa-cS: Preparing network interfaces based on configuration...
    epresa-cS: Adapter 1: nat
    epresa-cS: Adapter 2: hostonly
===> epresa-cS: Forwarding ports...
    epresa-cS: 22 (guest) => 2222 (host) (adapter 1)
===> epresa-cS: Running 'pre-boot' VM customizations...
===> epresa-cS: Booting VM...
===> epresa-cS: Waiting for machine to boot. This may take a few minutes...
    epresa-cS: SSH address: 127.0.0.1:2222
    epresa-cS: SSH username: vagrant
    epresa-cS: SSH auth method: private key
    epresa-cS:
    epresa-cS: Vagrant insecure key detected. Vagrant will automatically replace
    epresa-cS: this with a newly generated keypair for better security.
    epresa-cS:
    epresa-cS: Inserting generated public key within guest...
    epresa-cS: Removing insecure key from the guest if it's present...
    epresa-cS: Key inserted! Disconnecting and reconnecting using new SSH key...
===> epresa-cS: Machine booted and ready!
===> epresa-cS: Checking for guest additions in VM...
    epresa-cS: No guest additions were detected on the base box for this VM! Guest
    epresa-cS: additions are required for forwarded ports, shared folders, host only
    epresa-cS: networking, and more. If SSH fails on this machine, please install
    epresa-cS: the guest additions and repackage the box to continue.
    epresa-cS:
    epresa-cS: This is not an error message; everything may continue to work properly,
    epresa-cS: in which case you may ignore this message.
===> epresa-cS: Setting hostname...
===> epresa-cS: Configuring and enabling network interfaces...
===> epresa-cS: Running provisioner: shell...
    epresa-cS: Running: /tmp/vagrant-shell20240817-2566-lsaow1.sh
    epresa-cS: bootstrapping server...
===> epresa-cSW: Box 'centos/7' could not be found. Attempting to find and install...
    epresa-cSW: Box Provider: virtualbox
    epresa-cSW: Box Version: >= 0
===> epresa-cSW: Loading metadata for box 'centos/7'
    epresa-cSW: URL: https://vagrantcloud.com/api/v2/vagrant/centos/7
===> epresa-cSW: Adding box 'centos/7' (v2004.01) for provider: virtualbox
===> epresa-cSW: Cloning VM...
===> epresa-cSW: Matching MAC address for NAT networking...
===> epresa-cSW: Checking if box 'centos/7' version '2004.01' is up to date...
===> epresa-cSW: Setting the name of the VM: ServerWorker
===> epresa-cSW: Fixed port collision for 22 => 2222. Now on port 2200.
===> epresa-cSW: Clearing any previously set network interfaces...
===> epresa-cSW: Preparing network interfaces based on configuration...
    epresa-cSW: Adapter 1: nat
    epresa-cSW: Adapter 2: hostonly
===> epresa-cSW: Forwarding ports...
    epresa-cSW: 22 (guest) => 2200 (host) (adapter 1)
===> epresa-cSW: Running 'pre-boot' VM customizations...
===> epresa-cSW: Booting VM...
===> epresa-cSW: Waiting for machine to boot. This may take a few minutes...
    epresa-cSW: SSH address: 127.0.0.1:2200
    epresa-cSW: SSH username: vagrant
    epresa-cSW: SSH auth method: private key
    epresa-cSW:
    epresa-cSW: Vagrant insecure key detected. Vagrant will automatically replace
    epresa-cSW: this with a newly generated keypair for better security.
    epresa-cSW:
    epresa-cSW: Inserting generated public key within guest...
    epresa-cSW: Removing insecure key from the guest if it's present...
    epresa-cSW: Key inserted! Disconnecting and reconnecting using new SSH key...
===> epresa-cSW: Machine booted and ready!
===> epresa-cSW: Checking for guest additions in VM...
    epresa-cSW: No guest additions were detected on the base box for this VM! Guest
    epresa-cSW: additions are required for forwarded ports, shared folders, host only
    epresa-cSW: networking, and more. If SSH fails on this machine, please install
    epresa-cSW: the guest additions and repackage the box to continue.
    epresa-cSW:
    epresa-cSW: This is not an error message; everything may continue to work properly,
    epresa-cSW: in which case you may ignore this message.
===> epresa-cSW: Setting hostname...
===> epresa-cSW: Configuring and enabling network interfaces...
===> epresa-cSW: Running provisioner: shell...
    epresa-cSW: Running: /tmp/vagrant-shell20240817-2566-2sojqr.sh
    epresa-cSW: bootstrapping serverWorker...
----

=== Add an environment variable to the vagrantfile

Resource: https://www.ryanchapin.com/using-environment-variables-in-a-vagrant-file/[Using Environment Variables in a Vagrant File]

[source,patch]
----
-  control.vm.hostname =  ENV['WHOAMI']
+  control.vm.hostname = "epresa-cS"
----

Add environment variable

----
$ echo $WHOAMI
epresa-cS
----

But got this after `vagrant up`

----
Vagrant failed to initialize at a very early stage:

There was an error loading a Vagrantfile. The file being loaded
and the error message are shown below. This is usually caused by
an invalid or undefined variable.

Path: /opt/vagrant/embedded/gems/gems/vagrant-2.4.1/plugins/kernel_v2/config/vm.rb
Line number: 0
Message: undefined method `to_sym'
----

=== Connect over SSH

Launch

----
vagrant up
----

Connect with

----
vagrant ssh epresa-cS
vagrant ssh epresa-cSW
----

=== Get the sshd config

After to be connected to the machine, I print the sshd config

----
[vagrant@epresa-cS ~]$ sudo cat  /etc/ssh/sshd_config  | grep -v "^#" | grep -v "^$"
HostKey /etc/ssh/ssh_host_rsa_key
HostKey /etc/ssh/ssh_host_ecdsa_key
HostKey /etc/ssh/ssh_host_ed25519_key
SyslogFacility AUTHPRIV
AuthorizedKeysFile      .ssh/authorized_keys
PasswordAuthentication no
ChallengeResponseAuthentication no
GSSAPIAuthentication yes
GSSAPICleanupCredentials no
UsePAM yes
X11Forwarding yes
UseDNS no
AcceptEnv LANG LC_CTYPE LC_NUMERIC LC_TIME LC_COLLATE LC_MONETARY LC_MESSAGES
AcceptEnv LC_PAPER LC_NAME LC_ADDRESS LC_TELEPHONE LC_MEASUREMENT
AcceptEnv LC_IDENTIFICATION LC_ALL LANGUAGE
AcceptEnv XMODIFIERS
Subsystem       sftp    /usr/libexec/openssh/sftp-server
----

And print the public ssh key

----
[vagrant@epresa-cS ~]$ cat ~/.ssh/authorized_keys
ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIOWG7FyvvixzfNOgf6pR2IgNqjtBlGO06bnVAmTIp/XD vagrant
----

It's interresting, because we can understand that vagrant create automaticly ssh keys for the connection

== Setup a VPS

I discover a nice feature, https://en.wikipedia.org/wiki/Wake-on-LAN[Wake-on-LAN]

resouce: https://wiki.archlinux.org/title/Wake-on-LAN#On_the_same_LAN[arch wiki]

Got my mate public key with

----
curl https://github.com/${USERNAME}.keys
----

I choosed Arch linux as VPS ditribution because I am use to with this one.
And I want to know what is the best between arch and debian...

== VPS user

----
[theo@iot ~]$ vagrant plugin install virtualbox
Installing the 'virtualbox' plugin. This can take a few minutes...
Vagrant failed to properly resolve required dependencies. These
errors can commonly be caused by misconfigured plugin installations
or transient network issues. The reported error is:

conflicting dependencies bigdecimal (= 3.1.3) and bigdecimal (= 3.1.8)
  Activated bigdecimal-3.1.8
  which does not match conflicting dependency (= 3.1.3)

  Conflicting dependency chains:
    bigdecimal (= 3.1.8), 3.1.8 activated

  versus:
    bigdecimal (= 3.1.3)

  Gems matching bigdecimal (= 3.1.3):
    bigdecimal-3.1.3
----

Configure the firewall to avoid trouble from my mates
(avoid any ping to other devices)

[source, bash]
----
ufw deny out to 192.168.1.0/24 # my LAN
ufw allow out to 192.168.1.1 # gateway
ufw default allow outgoing # get access to the web
----

== Meetings

=== Cyber reunion

____
2024-08-20: 12h00 on discord
____

Why CentOS ?

No particular reasons

tgrivel want to setup a VPS at home for working
